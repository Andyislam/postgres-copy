<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Postgres Copy by diogob</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Postgres Copy</h1>
        <p>Simple PostgreSQL's COPY command support in ActiveRecord models</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/diogob/postgres-copy" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/diogob/postgres-copy/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/diogob/postgres-copy/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>postgres-copy</h1>

<p>This Gem will enable your AR models to use the PostgreSQL COPY command to import/export data in CSV format.
If you need to tranfer data between a PostgreSQL database and CSV files, the PostgreSQL native CSV parser
will give you a greater performance than using the ruby CSV+INSERT commands.
I have not found time to make accurate benchmarks, but in the use scenario where I have developed the gem
I have had a four-fold performance gain.
This gem was written having the Rails framework in mind, I think it could work only with active-record, 
but I will assume in this README that you are using Rails.</p>

<h2>Install</h2>

<p>Put it in your Gemfile</p>

<pre><code>gem 'postgres-copy'
</code></pre>

<p>Run the bundle command</p>

<pre><code>bundle
</code></pre>

<h2>Usage</h2>

<p>The gem will add two aditiontal class methods to ActiveRecord::Base:</p>

<ul>
<li>pg_copy_to </li>
<li>pg_copy_to_string</li>
<li>pg_copy_from</li>
</ul><h3>Using pg_copy_to and pg_copy_to_string</h3>

<p>You can go to the rails console and try some cool things first.
The first and most basic use case, let's copy the enteire content of a database table to a CSV file on the database server disk.
Assuming we have a users table and a User AR model:</p>

<pre><code>User.pg_copy_to '/tmp/users.csv'
</code></pre>

<p>This will execute in the database the command:</p>

<pre><code>COPY (SELECT "users".* FROM "users" ) TO '/tmp/users.csv' WITH DELIMITER ',' CSV HEADER
</code></pre>

<p>Remark that the file will be created in the database server disk.<br>
But what if you want to write the lines in a file on the server that is running Rails, instead of the database?<br>
In this case you can pass a block and retrieve the generated lines and then write them to a file:</p>

<pre><code>File.open('/tmp/users.csv', 'w') do |f|
  User.pg_copy_to do |line|
    f.write line
  end
end
</code></pre>

<p>Or, if you have enough memory, you can read all table contents to a string using .pg_copy_to_string</p>

<pre><code>puts User.pg_copy_to_string
</code></pre>

<p>Another insteresting feature of pg_copy_to is that it uses the scoped relation, it means that you can use ARel 
operations to generate different CSV files according to your needs.
Assuming we want to generate a file only with the names of users 1, 2 and 3:</p>

<pre><code>User.select("name").where(:id =&gt; [1,2,3]).pg_copy_to "/tmp/users.csv"
</code></pre>

<p>Which will generate the following SQL command:</p>

<pre><code>COPY (SELECT name FROM "users" WHERE "users"."id" IN (1, 2, 3)) TO '/tmp/users.csv' WITH DELIMITER ',' CSV HEADER
</code></pre>

<p>The COPY command also supports exporting the data in binary format.</p>

<pre><code>User.select("name").where(:id =&gt; [1,2,3]).pg_copy_to "/tmp/users.dat", :format =&gt; :binary
</code></pre>

<p>Which will generate the following SQL command:</p>

<pre><code>COPY (SELECT name FROM "users" WHERE "users"."id" IN (1, 2, 3)) TO '/tmp/users.dat' WITH BINARY
</code></pre>

<p>The copy_to_string method also supports this</p>

<pre><code>puts User.pg_copy_to_string(:format =&gt; :binary)
</code></pre>

<h3>Using pg_copy_from</h3>

<p>Now, if you want to copy data from a CSV file into the database, you can use the pg_copy_from method.
It will allow you to copy data from an arbritary IO object or from a file in the database server (when you pass the path as string).
Let's first copy from a file in the database server, assuming again that we have a users table and
that we are in the Rails console:</p>

<pre><code>User.pg_copy_from "/tmp/users.csv"
</code></pre>

<p>This command will use the headers in the CSV file as fields of the target table, so beware to always have a header in the files you want to import.
If the column names in the CSV header do not match the field names of the target table, you can pass a map in the options parameter.</p>

<pre><code>User.pg_copy_from "/tmp/users.csv", :map =&gt; {'name' =&gt; 'first_name'}
</code></pre>

<p>In the above example the header name in the CSV file will be mapped to the field called first_name in the users table.
You can also manipulate and modify the values of the file being imported before they enter into the database using a block:</p>

<pre><code>User.pg_copy_from "/tmp/users.csv" do |row|
  row[0] = "fixed string"
end
</code></pre>

<p>The above extample will always change the value of the first column to "fixed string" before storing it into the database.
For each iteration of the block row receives an array with the same order as the columns in the CSV file.</p>

<p>To copy a binary formatted data file or IO object you can specify the format as binary</p>

<pre><code>User.pg_copy_from "/tmp/users.dat", :format =&gt; :binary
</code></pre>

<p>NOTE: Columns must line up with the table unless you specify how they map to table columns.</p>

<p>To specify how the columns will map to the table you can specify the :columns option</p>

<pre><code>User.pg_copy_from "/tmp/users.dat", :format =&gt; :binary, :columns =&gt; [:id, :name]
</code></pre>

<p>Which will generate the following SQL command:</p>

<pre><code>COPY users (id, name) FROM '/tmp/users.dat' WITH BINARY
</code></pre>

<h3>Using the CSV Responder</h3>

<p>If you want to make the result of a COPY command available to download this gem provides a CSV responder that, in conjunction with <a href="https://github.com/josevalim/inherited_resources">inherited_resources</a>, is a very powerfull tool. BTW, do not try to use the responder without inherited_resources.</p>

<p>The advantage of using this CSV responder over generating the CSV file, is that it will iterate over the resulting lines and send them to the client as they became available, so you will not have any problem with memory consumption or timeouts executing the action.</p>

<p>Here's an example of controller using inherited resources and the CSV Responder:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Clients</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">inherit_resources</span>
  <span class="n">responders</span> <span class="ss">:csv</span>
  <span class="n">respond_to</span> <span class="ss">:csv</span>
  <span class="n">actions</span> <span class="ss">:index</span>
<span class="k">end</span>
</pre></div>

<p>The example above should be enough to generate a CSV file with clients (given that database and routes are set up accordingly) if you access the index action passing csv as the format.
The <a href="https://github.com/plataformatec/has_scope">has_scope</a> gem (included by default in inherited_resources) is very useful to filter the generated CSV file using model scopes.</p>

<p>You could use something such as:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Clients</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">inherit_resources</span>
  <span class="n">responders</span> <span class="ss">:csv</span>
  <span class="n">respond_to</span> <span class="ss">:csv</span>
  <span class="n">actions</span> <span class="ss">:index</span>
  <span class="n">has_scope</span> <span class="ss">:by_name</span>
<span class="k">end</span>
</pre></div>

<p>To filter clients by name using a corresponding model scope.
One could argue that this responder should be in a separate gem. But it's a very small piece of code and make the CSV available for download is a very common use case of postgres-copy.</p>

<h2>Note on Patches/Pull Requests</h2>

<ul>
<li>Fork the project.</li>
<li>Make your feature addition or bug fix.</li>
<li>Add tests for it. This is important so I don't break it in a
future version unintentionally.</li>
<li>Commit, do not mess with rakefile, version, or history.
(if you want to have your own version, that is fine but bump version in a commit by itself I can ignore when I pull)</li>
<li>Send me a pull request. Bonus points for topic branches.</li>
</ul><h2>Copyright</h2>

<p>Copyright (c) 2011 Diogo Biazus. See LICENSE for details.</p>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/diogob">diogob</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>